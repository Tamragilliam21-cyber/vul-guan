import subprocess
import re
import sys
import time
import os

def solve():
    # 这一行用来确认脚本确实启动了
    sys.stderr.write("[EXP] 脚本启动! 正在尝试运行 /readflag\n")
    sys.stderr.flush()
    
    try:
        # 启动 /readflag
        p = subprocess.Popen(
            ["/readflag"],
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True,
            bufsize=0
        )

        buffer = ""
        while True:
            # 读取一个字符
            char = p.stdout.read(1)
            if not char: break
            buffer += char
            
            # 实时打印到 stderr (配合配置文件的 1>&2 双重保险)
            sys.stderr.write(char)
            sys.stderr.flush()

            if "input your answer:" in buffer:
                break
        
        # 提取算式
        content = buffer.replace("input your answer:", "").strip()
        match = re.search(r'[\d\+\-\*\/\(\)\s]+$', content)
        
        if match:
            equation = match.group(0).strip()
            sys.stderr.write(f"\n[EXP] 找到算式: {equation}\n")
            
            # 计算
            answer = int(eval(equation))
            sys.stderr.write(f"[EXP] 计算结果: {answer}\n")
            
            # 发送答案
            p.stdin.write(f"{answer}\n")
            p.stdin.flush()
            
            # 读取 Flag
            rest = p.stdout.read()
            sys.stderr.write(f"\n[EXP] 最终输出:\n{rest}\n")
        else:
            sys.stderr.write("\n[EXP] 未找到算式\n")

    except Exception as e:
        sys.stderr.write(f"\n[EXP] 发生错误: {e}\n")

if __name__ == "__main__":
    solve()
